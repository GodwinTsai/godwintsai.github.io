{"title":"Timeline Note--引用无关资源","uid":"278122282ab7fc90233764072d390801","slug":"Timeline Note--引用无关资源","date":"2019-08-21T04:09:46.000Z","updated":"2022-07-16T11:30:57.000Z","comments":true,"path":"api/articles/Timeline Note--引用无关资源.json","keywords":null,"cover":[],"content":"<span id=\"more\"></span>\n\n<h2 id=\"一，环境：\"><a href=\"#一，环境：\" class=\"headerlink\" title=\"一，环境：\"></a>一，环境：</h2><p>Unity 2018.4.2</p>\n<h2 id=\"二，结构\"><a href=\"#二，结构\" class=\"headerlink\" title=\"二，结构\"></a>二，结构</h2><p><img src=\"https://img-blog.csdnimg.cn/20190821091449385.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaTYxMjc4MQ==,size_16,color_FFFFFF,t_70\" alt=\"图1\"><br>一个Prefab一段Timeline演出，Prefab上会挂PlayableDirector组件，并绑定Timeline Asset。<br><img src=\"https://img-blog.csdnimg.cn/20190821092510174.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaTYxMjc4MQ==,size_16,color_FFFFFF,t_70\" alt=\"图2\"><br>Timeline Asset的编辑内容</p>\n<h2 id=\"三，现象\"><a href=\"#三，现象\" class=\"headerlink\" title=\"三，现象\"></a>三，现象</h2><p><img src=\"https://img-blog.csdnimg.cn/20190821091730566.png\" alt=\"图3\"><br>对预制执行Select Dependencies发现：<br><img src=\"https://img-blog.csdnimg.cn/20190821091804823.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaTYxMjc4MQ==,size_16,color_FFFFFF,t_70\" alt=\"图4\"><br>该预制额外地引用了一些无关的资源，例如两个FBX资源，动作（skill2_x），甚至还引用了其它的Timeline Asset（4110092，BossShow）。</p>\n<h2 id=\"四，分析\"><a href=\"#四，分析\" class=\"headerlink\" title=\"四，分析\"></a>四，分析</h2><p>1，通过查看prefab和meta文件：<br><img src=\"https://img-blog.csdnimg.cn/20190821094322208.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaTYxMjc4MQ==,size_16,color_FFFFFF,t_70\" alt=\"图5\"><br>发现PlayableDirector的m_SceneBindings有很多guid的引用。但由图1、图2可见Timeline Asset中其实只有8个绑定。<br>2，选择Inspector的Debug模式<img src=\"https://img-blog.csdnimg.cn/20190821095033461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaTYxMjc4MQ==,size_16,color_FFFFFF,t_70\" alt=\"图6\"><br><img src=\"https://img-blog.csdnimg.cn/20190821095044203.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaTYxMjc4MQ==,size_16,color_FFFFFF,t_70\" alt=\"图7\"><br>发现竟然有28个绑定。<br>3，经测试发现，复制Prefab时，PlayableDirector组件的Binding也会跟着复制，即使关联新的TimelineAsset，也不会清空重新赋值，估计Unity后面版本会修复。</p>\n<h2 id=\"五，解决\"><a href=\"#五，解决\" class=\"headerlink\" title=\"五，解决\"></a>五，解决</h2><p>PlayableDirector组件的Binding字段是写在c++，也没有提供访问或清空的接口。因此采用重挂组件再赋值的办法。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">public static void OptimizeBinding(GameObject go)\n&#123;\n    var prefab &#x3D; GameObject.Instantiate(go);\n    var director &#x3D; prefab.GetComponent&lt;PlayableDirector&gt;();\n    if (director &#x3D;&#x3D; null)\n    &#123;\n        return;\n    &#125;\n    var timelineAsset &#x3D; director.playableAsset as TimelineAsset;\n    if (timelineAsset &#x3D;&#x3D; null)\n    &#123;\n        return;\n    &#125;\n    Dictionary&lt;UnityEngine.Object, UnityEngine.Object&gt; bindings &#x3D; new Dictionary&lt;UnityEngine.Object, UnityEngine.Object&gt;();\n    foreach (var pb in director.playableAsset.outputs)\n    &#123;\n        var key &#x3D; pb.sourceObject;\n        var value &#x3D; director.GetGenericBinding(key);\n        if (!bindings.ContainsKey(key))\n        &#123;\n            bindings.Add(key, value);\n        &#125;\n    &#125;\n    \n    GameObject.DestroyImmediate(director);\n    director &#x3D; prefab.AddComponent&lt;PlayableDirector&gt;();\n    director.playableAsset &#x3D; timelineAsset;\n    director.playOnAwake &#x3D; false;\n    foreach (var pair in bindings)\n    &#123;\n        director.SetGenericBinding(pair.Key, pair.Value);\n    &#125;\n    var path &#x3D; AssetDatabase.GetAssetPath(go);\n    PrefabUtility.SaveAsPrefabAsset(prefab, path, out var success);\n    GameObject.DestroyImmediate(prefab);\n&#125;</code></pre>\n\n<h2 id=\"六，结果\"><a href=\"#六，结果\" class=\"headerlink\" title=\"六，结果\"></a>六，结果</h2><p><img src=\"https://img-blog.csdnimg.cn/20190821112430959.png\" alt=\"图8\"><br><img src=\"https://img-blog.csdnimg.cn/20190821112444534.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaTYxMjc4MQ==,size_16,color_FFFFFF,t_70\" alt=\"图9\"><br>运行脚本后，Prefab不再引用不相关的资源，PlayableDirector的Binding数量也跟TimelineAsset的Track数量一致。</p>\n","text":" 一，环境：Unity 2018.4.2 二，结构一个Prefab一段Timeline演出，Prefab上会挂PlayableDirector组件，并绑定Timeline Asset。Timeline Asset的编辑内容 三，现象对预制执行Select Dependencies...","link":"","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[{"name":"Timeline","slug":"Timeline","count":2,"path":"api/categories/Timeline.json"}],"tags":[{"name":"Timeline 坑 资源引用 资源依赖","slug":"Timeline-坑-资源引用-资源依赖","count":1,"path":"api/tags/Timeline-坑-资源引用-资源依赖.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%80%EF%BC%8C%E7%8E%AF%E5%A2%83%EF%BC%9A\"><span class=\"toc-text\">一，环境：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BA%8C%EF%BC%8C%E7%BB%93%E6%9E%84\"><span class=\"toc-text\">二，结构</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%89%EF%BC%8C%E7%8E%B0%E8%B1%A1\"><span class=\"toc-text\">三，现象</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9B%9B%EF%BC%8C%E5%88%86%E6%9E%90\"><span class=\"toc-text\">四，分析</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BA%94%EF%BC%8C%E8%A7%A3%E5%86%B3\"><span class=\"toc-text\">五，解决</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%85%AD%EF%BC%8C%E7%BB%93%E6%9E%9C\"><span class=\"toc-text\">六，结果</span></a></li></ol>","author":{"name":"GodwinTsai","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"https://github.com/GodwinTsai","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"批量删除预制脚本","uid":"cf6a4766c3507937614ad6819b2f17d9","slug":"批量删除预制脚本","date":"2020-01-02T16:54:06.000Z","updated":"2022-07-16T11:30:57.000Z","comments":true,"path":"api/articles/批量删除预制脚本.json","keywords":null,"cover":[],"text":" 环境：Unity 2018.4.12需求：项目中经常需要在Unity Editor模式下批量删除Prefab中的某个脚本，但是直接用&#96;GameObject.DestroyImmediate(obj);&#96;会报错：Destroying assets is not p...","link":"","photos":[],"count_time":{"symbolsCount":"7k","symbolsTime":"6 mins."},"categories":[{"name":"Unity","slug":"Unity","count":5,"path":"api/categories/Unity.json"}],"tags":[],"author":{"name":"GodwinTsai","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"https://github.com/GodwinTsai","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Timeline 一，简介","uid":"077ece2c7670b51ed3e04645fca4119e","slug":"Timeline 一，简介","date":"2019-08-12T12:00:51.000Z","updated":"2022-07-16T11:30:57.000Z","comments":true,"path":"api/articles/Timeline 一，简介.json","keywords":null,"cover":[],"text":" 尊重原创，转载请在文首注明出处：https://blog.csdn.net/cai612781/article/details/99330696 环境： Unity 2018.4 一，Introduction 1.1,Timeline Timeline是Unity2017新增的...","link":"","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"Timeline","slug":"Timeline","count":2,"path":"api/categories/Timeline.json"}],"tags":[{"name":"Timeline","slug":"Timeline","count":1,"path":"api/tags/Timeline.json"}],"author":{"name":"GodwinTsai","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"https://github.com/GodwinTsai","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}