<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>GodwinTsai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="蔡国荣">
<meta property="og:type" content="website">
<meta property="og:title" content="GodwinTsai">
<meta property="og:url" content="http://godwintsai.github.io/page/2/">
<meta property="og:site_name" content="GodwinTsai">
<meta property="og:description" content="蔡国荣">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="GodwinTsai">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="GodwinTsai" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">GodwinTsai</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://godwintsai.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-C#复制文件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/01/09/C#%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2018-01-09T09:22:12.000Z" itemprop="datePublished">2018-01-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/01/09/C#%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6/">C#复制文件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <span id="more"></span>

<p>尊重原创，转载请在文首注明出处：<a target="_blank" rel="noopener" href="http://blog.csdn.net/cai612781/article/details/79015286">http://blog.csdn.net/cai612781/article/details/79015286</a></p>
<p>开发Unity编辑器工具中经常遇到需要把文件复制到工程中，例如数据、图片等。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Assets.Editor</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title">FileUtil</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//比较两个文件夹，获得改动的文件</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FileInfo[] <span class="title">GetNeedCopyFiles</span>(<span class="params"><span class="built_in">string</span> srcPath, <span class="built_in">string</span> desPath, <span class="built_in">bool</span> forceCopy = <span class="literal">false</span></span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			FileInfo[] files = &#123;&#125;;</span><br><span class="line">			List&lt;FileInfo&gt; fileInfoList = <span class="keyword">new</span> List&lt;FileInfo&gt;();</span><br><span class="line">			DirectoryInfo srcDirInfo = <span class="keyword">new</span> DirectoryInfo(srcPath);</span><br><span class="line">			DirectoryInfo desDirInfo = <span class="keyword">new</span> DirectoryInfo(desPath);</span><br><span class="line">			<span class="keyword">if</span>(!srcDirInfo.Exists)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> files;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(!desDirInfo.Exists)</span><br><span class="line">			&#123;</span><br><span class="line">				Directory.CreateDirectory(desPath);</span><br><span class="line">			&#125;</span><br><span class="line">			FileInfo[] fileArr = srcDirInfo.GetFiles();</span><br><span class="line">			<span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, len = fileArr.Length; i &lt; len; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">string</span> filePath = desDirInfo.FullName + <span class="string">&quot;\\&quot;</span> + fileArr[i].Name;</span><br><span class="line">				FileInfo fileInfo = <span class="keyword">new</span> FileInfo(filePath);</span><br><span class="line">				<span class="keyword">if</span>(!fileInfo.Exists)</span><br><span class="line">				&#123;</span><br><span class="line">					fileInfoList.Add(fileArr[i]);</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(forceCopy || fileArr[i].Length != fileInfo.Length)</span><br><span class="line">				&#123;</span><br><span class="line">					fileInfoList.Add(fileArr[i]);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			files = fileInfoList.ToArray();</span><br><span class="line">			<span class="keyword">return</span> files;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//拷贝文件到目标路径</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CopyFiles</span>(<span class="params">ileInfo[] infos, <span class="built_in">string</span> desPath</span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">string</span> desFileName;</span><br><span class="line">			FileInfo file;</span><br><span class="line">			<span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, len = infos.Length; i &lt; len; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				file = infos[i];</span><br><span class="line">				desFileName = Path.Combine(desPath, file.Name);</span><br><span class="line">				<span class="keyword">if</span>(File.Exists(desFileName))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">new</span> FileInfo(desFileName).IsReadOnly = <span class="literal">false</span>;<span class="comment">//注1</span></span><br><span class="line">				&#125;</span><br><span class="line">				file.CopyTo(desFileName, <span class="literal">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注1：</p>
<p>当删除文件或者复制文件时选择覆盖，如果该文件是个只读文件，则会抛出异常：System.UnauthorizedAccessException。</p>
<p>解决方法是：</p>
<p>new FileInfo(filePath).IsReadOnly &#x3D; false;</p>
<p>或者：</p>
<p>new FileInfo(filePath).Attributes &#x3D; FileAttributes.Normal;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://godwintsai.github.io/2018/01/09/C#%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6/" data-id="cl5nt970o0000mpuv2pckfsd1" data-title="C#复制文件" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6-%E5%88%A0%E9%99%A4%E5%8F%AA%E8%AF%BB%E6%96%87%E4%BB%B6%E5%BC%82%E5%B8%B8/" rel="tag">C#复制文件 删除只读文件异常</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-C#调用SVN" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/01/09/C#%E8%B0%83%E7%94%A8SVN/" class="article-date">
  <time class="dt-published" datetime="2018-01-09T09:10:37.000Z" itemprop="datePublished">2018-01-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/01/09/C#%E8%B0%83%E7%94%A8SVN/">C#调用SVN</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <span id="more"></span>

<p>尊重原创，转载请在文首注明出处：<a target="_blank" rel="noopener" href="http://blog.csdn.net/cai612781/article/details/79015085">http://blog.csdn.net/cai612781/article/details/79015085</a></p>
<p>一，语法</p>
<p>项目开发中通常都会使用Subversion(SVN)作为版本控制系统，同时会使用SVN的客户端软件TortoiseSVN。</p>
<p>我们通过TortoiseSVN的TortoiseProc.exe程序添加参数，来实现在C#或bat批处理脚本中调用SVN。<br>举个栗子： TortoiseProc.exe &#x2F;command:update &#x2F;path:xxx &#x2F;closeonend:0</p>
<p>&#x2F;command表示SVN的操作命令</p>
<p>&#x2F;path表示操作的路径，可以有多个，用*分隔</p>
<p>&#x2F;closeonend用于在执行完毕后关闭对话框：</p>
<p>&#x2F;closeonend:0不自动关闭对话框</p>
<p>&#x2F;closeonend:1没有错误，则自动关闭对话框</p>
<p>&#x2F;closeonend:2没有错误、冲突，则自动关闭对话框</p>
<p>&#x2F;closeonend:3没有错误、冲突、合并，自动关闭对话框</p>
<p> </p>
<p>二，代码</p>
<p> </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Assets.Editor.Svn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SvnUtil</span> : <span class="title">UnityEditor.Editor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> _svnPath = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DelAndUpdateSvnFile</span>(<span class="params"><span class="built_in">string</span> path</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (File.Exists(path))</span><br><span class="line">            &#123;</span><br><span class="line">                File.Delete(path);</span><br><span class="line">            &#125;</span><br><span class="line">            ExecuteProcess(GetSvnProcPath(), <span class="built_in">string</span>.Format(<span class="string">&quot;/command:update /path:&#123;0&#125; /closeonend:2&quot;</span>, path));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RevertAndUpdateSvnDirectory</span>(<span class="params"><span class="built_in">string</span> path</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ExecuteProcess(GetSvnProcPath(), <span class="built_in">string</span>.Format(<span class="string">&quot;/command:revert -r /path:&#123;0&#125; /closeonend:2&quot;</span>, path));</span><br><span class="line">            ExecuteProcess(GetSvnProcPath(), <span class="built_in">string</span>.Format(<span class="string">&quot;/command:update /path:&#123;0&#125; /closeonend:2&quot;</span>, path));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UpdateSvnDirectory</span>(<span class="params"><span class="built_in">string</span> path</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ExecuteProcess(GetSvnProcPath(), <span class="built_in">string</span>.Format(<span class="string">&quot;/command:update /path:&#123;0&#125; /closeonend:2&quot;</span>, path));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CommitSvnDirectory</span>(<span class="params"><span class="built_in">string</span> path</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ExecuteProcess(GetSvnProcPath(), <span class="built_in">string</span>.Format(<span class="string">&quot;/command:commit /path:&#123;0&#125; /closeonend:0&quot;</span>, path));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ProcessSvnCommand</span>(<span class="params"><span class="built_in">string</span> command</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ExecuteProcess(GetSvnProcPath(), command);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="built_in">string</span>&gt; drives = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;() &#123; <span class="string">&quot;c:&quot;</span>, <span class="string">&quot;d:&quot;</span>, <span class="string">&quot;e:&quot;</span>, <span class="string">&quot;f:&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> svnPath = <span class="string">@&quot;\Program Files\TortoiseSVN\bin\&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> svnProc = <span class="string">@&quot;TortoiseProc.exe&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> svnProcPath = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetSvnProcPath</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_svnPath != <span class="built_in">string</span>.Empty)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _svnPath;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> item <span class="keyword">in</span> drives)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> path = <span class="built_in">string</span>.Concat(item, svnPath, svnProc);</span><br><span class="line">                <span class="keyword">if</span> (File.Exists(path))</span><br><span class="line">                &#123;</span><br><span class="line">                    _svnPath = path;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_svnPath == <span class="built_in">string</span>.Empty)</span><br><span class="line">            &#123;</span><br><span class="line">                _svnPath = EditorUtility.OpenFilePanel(<span class="string">&quot;Select TortoiseProc.exe&quot;</span>, <span class="string">&quot;c:\\&quot;</span>, <span class="string">&quot;exe&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//可将路径存到本地注册表</span></span><br><span class="line">            <span class="keyword">return</span> _svnPath;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecuteProcess</span>(<span class="params"><span class="built_in">string</span> filePath, <span class="built_in">string</span> command, <span class="built_in">int</span> seconds = <span class="number">0</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            EditorUtil.ExecuteProcess(filePath, command, <span class="string">&quot;&quot;</span>, seconds);<span class="comment">//参见文末另一篇：C#调用可执行文件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EditorUtil.ExecuteProcess 参见另一篇：<a target="_blank" rel="noopener" href="https://blog.csdn.net/cai612781/article/details/79030654">C#调用可执行文件</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://godwintsai.github.io/2018/01/09/C#%E8%B0%83%E7%94%A8SVN/" data-id="cl5nt970s0001mpuvfmtzhhzq" data-title="C#调用SVN" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C-%E8%B0%83%E7%94%A8SVN/" rel="tag">C#调用SVN</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Unity协程&amp;在编辑器中使用协程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/01/07/Unity%E5%8D%8F%E7%A8%8B&%E5%9C%A8%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8D%8F%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2018-01-06T17:42:45.000Z" itemprop="datePublished">2018-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Unity/">Unity</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/01/07/Unity%E5%8D%8F%E7%A8%8B&%E5%9C%A8%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8D%8F%E7%A8%8B/">Unity协程&amp;在编辑器中使用协程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <span id="more"></span>

<h2 id="尊重原创，转载请在文首注明出处：http-blog-csdn-net-cai612781-article-details-78992805"><a href="#尊重原创，转载请在文首注明出处：http-blog-csdn-net-cai612781-article-details-78992805" class="headerlink" title="尊重原创，转载请在文首注明出处：http://blog.csdn.net/cai612781/article/details/78992805"></a>尊重原创，转载请在文首注明出处：<a target="_blank" rel="noopener" href="http://blog.csdn.net/cai612781/article/details/78992805">http://blog.csdn.net/cai612781/article/details/78992805</a></h2><h2 id="一，定义"><a href="#一，定义" class="headerlink" title="一，定义"></a>一，定义</h2><p>Unity协程(Coroutine)，不是卖机票的携程，是一种类似子线程的机制，可以用来实现一些延时处理的需求，c#中通过yield return语句配合可以中断执行，延时一定时间后从中断处继续执行。</p>
<h2 id="二，注意"><a href="#二，注意" class="headerlink" title="二，注意"></a>二，注意</h2><p>协程不是线程，协程不是线程，协程不是线程，协程还是在主线程里！！！</p>
<h2 id="三，语法"><a href="#三，语法" class="headerlink" title="三，语法"></a>三，语法</h2><p>脚本需要继承MonoBehaviour，提供了两个方法StartCoroutine(IEnumerator routine)或者StartCoroutine(string methodName)开启一个协程，以及对应的StopCoroutine(IEnumerator routine)或StopCoroutine(string methodName)关闭协程。推荐使用前者，因为传递方法名需要用到反射机制，影响性能。</p>
<h2 id="四，常见应用"><a href="#四，常见应用" class="headerlink" title="四，常见应用"></a>四，常见应用</h2><p>1）延时（别想歪）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExampleClass</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">IEnumerator <span class="title">Start</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Debug.Log(<span class="string">&quot;Start--&quot;</span> + Time.time);</span><br><span class="line">		<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="title">StartCoroutine</span>(<span class="params">WaitAndLog</span>)</span>;</span><br><span class="line">		Debug.Log(<span class="string">&quot;End--&quot;</span> + Time.time);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IEnumerator <span class="title">WaitAndLog</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">3</span></span>)</span>;</span><br><span class="line">		Debug.Log(<span class="string">&quot;Wait--&quot;</span> + Time.time);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）分帧加载</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExampleClass</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> _num,_total;</span><br><span class="line">	Start()</span><br><span class="line">	&#123;</span><br><span class="line">		StartCoroutine(LoadAssets);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IEnumerator <span class="title">LoadAssets</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(_num &lt; _total)</span><br><span class="line">		&#123;</span><br><span class="line">			_num++;</span><br><span class="line">			Debug.Log(<span class="string">&quot;Load an Asset&quot;</span>);</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五，yield"><a href="#五，yield" class="headerlink" title="五，yield"></a>五，yield</h2><p>yield语句用于暂停协程的执行，yield return 的值决定什么时候恢复协程的执行。yield return 返回一个IEnumerator对象，当该对象的MoveNext()返回false，即该对象的Current已迭代到最后一个元素时，才会执行yield return后的代码。</p>
<p>yield语句的返回有如下类型：</p>
<p>yield return null;&#x2F;&#x2F;下一帧再继续往下执行</p>
<p>yield return new WaitForFixedUpdate();&#x2F;&#x2F;等到下一次调用FixedUpdate再往下执行</p>
<p>yield return new WaitForSceonds(n);&#x2F;&#x2F;等待n秒再往下执行</p>
<p>yield return StartCoroutine(Method);&#x2F;&#x2F;开启另一个协程，直到Method执行完毕再往下执行</p>
<p>yield return new WaitForEndOfFrame();&#x2F;&#x2F;等到该帧结束再往下执行</p>
<p>yield return WWW;&#x2F;&#x2F;等待资源加载完成再往下执行</p>
<p>yield break;&#x2F;&#x2F;结束协程</p>
<h2 id="六，执行顺序"><a href="#六，执行顺序" class="headerlink" title="六，执行顺序"></a>六，执行顺序</h2><p>协程是每帧lateUpdate前执行yield return之前的代码，lateUpdate后执行yield return之后的代码。</p>
<p>不同yield return返回值的执行顺序，通过官方文档的一张流程图可以清晰地了解：</p>
<p><a target="_blank" rel="noopener" href="http://docs.unity3d.com/uploads/Main/monobehaviour_flowchart.svg">http://docs.unity3d.com/uploads/Main/monobehaviour_flowchart.svg</a>  </p>
<h2 id="七，原理"><a href="#七，原理" class="headerlink" title="七，原理"></a>七，原理</h2><p>Unity的协程应该是一个扩展成支持嵌套的迭代器（IEnumator）。</p>
<p>它将c# IEnumerator封装为Coroutine对象，它记录了该协程的上一级协程是谁，当这个协程执行完成，会继续执行上一级协程。</p>
<p>当Unity Coroutine调用IEnumerator的MoveNext返回一个新Coroutine时，Unity设置新对象的上级Coroutine为当前Coroutine，同时将新Coroutine压入队列，通过此实现嵌套。</p>
<p>然后Unity在主线程中定时检测当前每个等待的Coroutine，满足条件则执行。</p>
<h2 id="八，在Editor下使用Coroutine"><a href="#八，在Editor下使用Coroutine" class="headerlink" title="八，在Editor下使用Coroutine"></a>八，在Editor下使用Coroutine</h2><p>编辑器下因为没有运行Unity，也没有创建GameObject，因此也无法通过Monobehaviour的StartCoroutine创建协程。</p>
<p>以下代码来自网上不知哪位大牛，根据Unity协程原理另外实现了个协程：</p>
<p>1，EditorCoroutine协程类实现了IEnumerator接口，在MoveNext函数中实现了嵌套调用协程</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EditorCoroutine</span> : <span class="title">IEnumerator</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">private</span> Stack&lt;IEnumerator&gt; executionStack;  </span><br><span class="line">  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EditorCoroutine</span>(<span class="params">IEnumerator iterator</span>)</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">this</span>.executionStack = <span class="keyword">new</span> Stack&lt;IEnumerator&gt;();  </span><br><span class="line">            <span class="keyword">this</span>.executionStack.Push(iterator);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">MoveNext</span>()</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            IEnumerator i = <span class="keyword">this</span>.executionStack.Peek();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (i.MoveNext())  </span><br><span class="line">            &#123;  </span><br><span class="line">                <span class="built_in">object</span> result = i.Current;  </span><br><span class="line">                <span class="keyword">if</span> (result != <span class="literal">null</span> &amp;&amp; result <span class="keyword">is</span> IEnumerator)  </span><br><span class="line">                &#123;  </span><br><span class="line">                    <span class="keyword">this</span>.executionStack.Push((IEnumerator)result);  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span>  </span><br><span class="line">            &#123;  </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.executionStack.Count &gt; <span class="number">1</span>)  </span><br><span class="line">                &#123;  </span><br><span class="line">                    <span class="keyword">this</span>.executionStack.Pop();  </span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Reset</span>()</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> System.NotSupportedException(<span class="string">&quot;This Operation Is Not Supported.&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">object</span> Current  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.executionStack.Peek().Current; &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Find</span>(<span class="params">IEnumerator iterator</span>)</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.executionStack.Contains(iterator);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br></pre></td></tr></table></figure>

<p>2，EditorCoroutineRunner类，类似MonoBehaviour，提供了StartEditorCoroutine方法创建一个协程</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EditorCoroutineRunner</span>  </span><br><span class="line">&#123;      </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;EditorCoroutine&gt; editorCoroutineList;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;IEnumerator&gt; buffer;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerator <span class="title">StartEditorCoroutine</span>(<span class="params">IEnumerator iterator</span>)</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">if</span> (editorCoroutineList == <span class="literal">null</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            editorCoroutineList = <span class="keyword">new</span> List&lt;EditorCoroutine&gt;();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (buffer == <span class="literal">null</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            buffer = <span class="keyword">new</span> List&lt;IEnumerator&gt;();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (editorCoroutineList.Count == <span class="number">0</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            EditorApplication.update += Update;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        buffer.Add(iterator);  </span><br><span class="line">      </span><br><span class="line">        <span class="keyword">return</span> iterator;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Find</span>(<span class="params">IEnumerator iterator</span>)</span>  </span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="keyword">foreach</span> (EditorCoroutine editorCoroutine <span class="keyword">in</span> editorCoroutineList)  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">if</span> (editorCoroutine.Find(iterator))  </span><br><span class="line">            &#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Update</span>()</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        editorCoroutineList.RemoveAll  </span><br><span class="line">        (  </span><br><span class="line">            coroutine =&gt; &#123; <span class="keyword">return</span> coroutine.MoveNext() == <span class="literal">false</span>; &#125;  </span><br><span class="line">        );  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (buffer.Count &gt; <span class="number">0</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">foreach</span> (IEnumerator iterator <span class="keyword">in</span> buffer)  </span><br><span class="line">            &#123;  </span><br><span class="line">                <span class="keyword">if</span> (!Find(iterator))  </span><br><span class="line">                &#123;  </span><br><span class="line">                    editorCoroutineList.Add(<span class="keyword">new</span> EditorCoroutine(iterator));  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            buffer.Clear();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (editorCoroutineList.Count == <span class="number">0</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            EditorApplication.update -= Update;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>3，调用</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExampleClass</span></span><br><span class="line">&#123;</span><br><span class="line">	Start()</span><br><span class="line">	&#123;</span><br><span class="line">		EditorCoroutineRunner.StartEditorCoroutine(Routine);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IEnumerator <span class="title">Routine</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Debug.Log(<span class="string">&quot;Routine&quot;</span>);</span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="九，参考"><a href="#九，参考" class="headerlink" title="九，参考"></a>九，参考</h2><p><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/10552">http://gad.qq.com/article/detail/10552</a>  </p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/langresser_king/article/details/44244369">http://blog.csdn.net/langresser_king/article/details/44244369</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://godwintsai.github.io/2018/01/07/Unity%E5%8D%8F%E7%A8%8B&%E5%9C%A8%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8D%8F%E7%A8%8B/" data-id="cl5nt9714000ompuvh67j8ka7" data-title="Unity协程&amp;在编辑器中使用协程" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity-coroutine-unity%E5%8D%8F%E7%A8%8B-use-coroutine-in-uni-%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8D%8F%E7%A8%8B/" rel="tag">unity coroutine unity协程 use coroutine in uni 编辑器中使用协程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ETC1+Alpha纹理压缩自动化脚本" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/12/13/ETC1+Alpha%E7%BA%B9%E7%90%86%E5%8E%8B%E7%BC%A9%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC/" class="article-date">
  <time class="dt-published" datetime="2017-12-13T15:28:47.000Z" itemprop="datePublished">2017-12-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Ngui/">Ngui</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/12/13/ETC1+Alpha%E7%BA%B9%E7%90%86%E5%8E%8B%E7%BC%A9%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC/">ETC1+Alpha纹理压缩自动化脚本</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <span id="more"></span>

<p>尊重原创，转载请在文首注明出处：<a target="_blank" rel="noopener" href="http://blog.csdn.net/cai612781/article/details/78798054">http://blog.csdn.net/cai612781/article/details/78798054</a>  </p>
<p>一，压缩方式</p>
<p>我们在Unity中对于图集和纹理，常用的压缩方案按照质量从低到高可以分为：</p>
<p>高压缩：Android:ETC1+Alpha, IOS:PVRTC4<br>中压缩：RGBA16+Dithering<br>无压缩：RGBA32  </p>
<p>二，自动化脚本  </p>
<p>有很多工具可以处理上述压缩方案，例如TexturePack。今天来总结下采用脚本自动将纹理生成ETC1+Alpha的压缩方案。</p>
<p>采用的是Unity自带的一个压缩&#x2F;解压缩ETC格式的图像工具：etcpack.exe。在Unity 4.x中可以在Unity安装目录&#x2F;Editor&#x2F;Data&#x2F;Tools&#x2F;中找到，Unity5.x中就被移除了。<br>更多参考： <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ericsson_Texture_Compression">https://en.wikipedia.org/wiki/Ericsson_Texture_Compression</a>  </p>
<p>1，有了这个工具，我们并不知道怎么用。首先打开cmd，在cmd中运行这个exe。可以看到输出了使用方法和例子。<br><img src="https://img-blog.csdn.net/20180107013506565"> <img src="https://img-blog.csdn.net/20180107013550385">  </p>
<p>2，接着我们写个bat脚本来调用这个工具，保存为etc.bat文件  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@echo etc tool</span><br><span class="line">@echo %1</span><br><span class="line">@echo %2</span><br><span class="line">@echo %3</span><br><span class="line">@echo %4</span><br><span class="line">@echo %5</span><br><span class="line">@echo %6</span><br><span class="line">@echo %7</span><br><span class="line">@echo %8</span><br><span class="line">@set pngPath=%1</span><br><span class="line">@set outputPath=%2</span><br><span class="line">@set pkmPath=%3</span><br><span class="line">@set alphaPkmPath=%4</span><br><span class="line">@set pkmName=%5</span><br><span class="line">@set alphaPkmName=%6</span><br><span class="line">@set etcToolPath=%7</span><br><span class="line">@set speed=%8</span><br><span class="line"></span><br><span class="line">cd /d %etcToolPath%</span><br><span class="line">@echo Convert PNG to PKM without alpha channel and solo alpha PKM files</span><br><span class="line">etcpack %pngPath% %outputPath% -c etc1 -s %speed% -as -progress</span><br><span class="line">@echo Convert PKM files to PNG files</span><br><span class="line">etcpack %pkmPath% %outputPath% -ext PNG</span><br><span class="line">etcpack %alphaPkmPath% %outputPath% -ext PNG</span><br><span class="line">@echo Remove PKM files</span><br><span class="line">cd /d %outputPath%</span><br><span class="line">del %pkmName% /f</span><br><span class="line">del %alphaPkmName% /f</span><br><span class="line">@echo DONE</span><br><span class="line">#pause</span><br></pre></td></tr></table></figure>

<p>3，我们在Unity中调用这个bat脚本，主要步骤有：</p>
<p>A，C#创建cmd进程的方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecuteProcess</span>(<span class="params"><span class="built_in">string</span> filePath, <span class="built_in">string</span> command, <span class="built_in">string</span> workPath = <span class="string">&quot;&quot;</span>, <span class="built_in">int</span> seconds = <span class="number">0</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(filePath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Process process = <span class="keyword">new</span> Process();<span class="comment">//创建进程对象</span></span><br><span class="line">            process.StartInfo.WorkingDirectory = workPath;</span><br><span class="line">            process.StartInfo.FileName = filePath;</span><br><span class="line">            process.StartInfo.Arguments = command;</span><br><span class="line">            process.StartInfo.CreateNoWindow = <span class="literal">true</span>;</span><br><span class="line">            process.StartInfo.RedirectStandardOutput = <span class="literal">false</span>;<span class="comment">//不重定向输出</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (process.Start())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (seconds == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        process.WaitForExit(); <span class="comment">//无限等待进程结束</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        process.WaitForExit(seconds); <span class="comment">//等待毫秒</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(e.Message);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                process.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>B，通过A中方法传入参数执行etc.bat，方法参数是图片asset</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CompressPngToEtc</span>(<span class="params">UnityEngine.Object asset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> pngPath = <span class="built_in">string</span>.Concat(Application.dataPath.Replace(<span class="string">&quot;/Assets&quot;</span>, <span class="string">&quot;/&quot;</span>),</span><br><span class="line">                AssetDatabase.GetAssetPath(asset));</span><br><span class="line">            <span class="built_in">string</span> etcToolPath = <span class="built_in">string</span>.Concat(Application.dataPath.Replace(<span class="string">&quot;/Assets&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="string">&quot;/tools/etc_tool/&quot;</span>);</span><br><span class="line">            <span class="built_in">string</span> etcBatPath = etcToolPath + <span class="string">&quot;/etc.bat&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> pngName = asset.name + <span class="string">&quot;png&quot;</span>;</span><br><span class="line">            <span class="built_in">string</span> pngFolderPath = Path.GetDirectoryName(pngPath);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> outputPath = pngFolderPath + <span class="string">&quot;/etc&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> pkmName = pngName.Replace(<span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.pkm&quot;</span>);</span><br><span class="line">            <span class="built_in">string</span> pkmPath = outputPath + <span class="string">&quot;/&quot;</span> + pkmName;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> alphaPkmName = pngName.Replace(<span class="string">&quot;.png&quot;</span>, <span class="string">&quot;_alpha.pkm&quot;</span>);</span><br><span class="line">            <span class="built_in">string</span> alphaPkmPath = outputPath + <span class="string">&quot;/&quot;</span> + alphaPkmName;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> speed = <span class="string">&quot;fast&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> args = <span class="built_in">string</span>.Format(<span class="string">&quot;\&quot;&#123;0&#125;\&quot; \&quot;&#123;1&#125;\&quot; \&quot;&#123;2&#125;\&quot; \&quot;&#123;3&#125;\&quot; &#123;4&#125; &#123;5&#125; \&quot;&#123;6&#125;\&quot; &#123;7&#125;&quot;</span>, pngPath, outputPath,</span><br><span class="line">                pkmPath, alphaPkmPath, pkmName, alphaPkmName, etcToolPath, speed);</span><br><span class="line">            ExecuteProcess(etcBatPath, args);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>C，增加编辑器菜单选择要处理的图片</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">MenuItem(<span class="string">&quot;Assets/Compress png 2 etc&quot;</span>, false, 10001)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateEtc</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> path;</span><br><span class="line">    UnityEngine.Object matAsset;</span><br><span class="line">    UnityEngine.Object[] selectedAssets = Selection.GetFiltered(<span class="keyword">typeof</span>(Texture2D), SelectionMode.DeepAssets);</span><br><span class="line">    <span class="keyword">foreach</span> (Object asset <span class="keyword">in</span> selectedAssets)</span><br><span class="line">    &#123;</span><br><span class="line">        path = AssetDatabase.GetAssetPath(asset);</span><br><span class="line">        matAsset = AssetDatabase.LoadAssetAtPath(path.Replace(<span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.mat&quot;</span>), <span class="keyword">typeof</span> (Material)) <span class="keyword">as</span> Material;</span><br><span class="line">        <span class="keyword">if</span> (matAsset != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            CompressPngToEtc(asset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="meta">MenuItem(<span class="string">&quot;Assets/Compress png 2 etc&quot;</span>, true, 10001)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CreateEtcEnabled</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Selection.objects.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> obj = Selection.objects[i];</span><br><span class="line">        <span class="keyword">var</span> filePath = AssetDatabase.GetAssetPath(obj);</span><br><span class="line">        <span class="keyword">if</span> (filePath.EndsWith(<span class="string">&quot;.png&quot;</span>, System.StringComparison.CurrentCultureIgnoreCase) ||</span><br><span class="line">            filePath.EndsWith(<span class="string">&quot;.jpg&quot;</span>, System.StringComparison.CurrentCultureIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>D，生成rgb图片以及alpha图片后设置图片格式  </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetTextureType</span>(<span class="params"><span class="built_in">string</span> path, TextureImporterFormat format, FilterMode mode = FilterMode.Bilinear</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            TextureImporter importer = AssetImporter.GetAtPath(path) <span class="keyword">as</span> TextureImporter;</span><br><span class="line">            <span class="keyword">if</span> (importer != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                importer.textureType = TextureImporterType.Sprite;</span><br><span class="line">                importer.textureFormat = format;</span><br><span class="line">                importer.filterMode = mode;</span><br><span class="line">                importer.mipmapEnabled = <span class="literal">false</span>;</span><br><span class="line">                </span><br><span class="line">                TextureImporterSettings tis = <span class="keyword">new</span> TextureImporterSettings();</span><br><span class="line">                importer.ReadTextureSettings(tis);</span><br><span class="line">                importer.SetTextureSettings(tis);</span><br><span class="line">                AssetDatabase.ImportAsset(path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetTextureTypeCompressed</span>(<span class="params"><span class="built_in">object</span> pngAsset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">	    Texture2D mainTexture = AssetDatabase.LoadAssetAtPath(pngPath.Replace(pngAsset.name, <span class="string">&quot;etc/&quot;</span> + pngAsset.name), <span class="keyword">typeof</span> (Texture2D)) <span class="keyword">as</span> Texture2D;</span><br><span class="line">            Texture2D alphaTexture = AssetDatabase.LoadAssetAtPath(pngPath.Replace(pngAsset.name, <span class="string">&quot;etc/&quot;</span> + pngAsset.name + <span class="string">&quot;_alpha&quot;</span>), <span class="keyword">typeof</span> (Texture2D)) <span class="keyword">as</span> Texture2D;</span><br><span class="line">            <span class="built_in">string</span> mainPath = AssetDatabase.GetAssetPath(mainTexture);</span><br><span class="line">            <span class="built_in">string</span> alphaPath = AssetDatabase.GetAssetPath(alphaTexture);</span><br><span class="line">            SetTextureType(mainPath, TextureImporterFormat.AutomaticCompressed);</span><br><span class="line">            SetTextureType(alphaPath, TextureImporterFormat.AutomaticCompressed);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>E，设置材质球Shader为UIETC，并引用两张生成的图片</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetMaterialEtcShader</span>(<span class="params">UnityEngine.Object asset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> path;</span><br><span class="line">            Material mat;</span><br><span class="line">            Texture2D mainTexture;</span><br><span class="line">            Texture2D alphaTexture;</span><br><span class="line"></span><br><span class="line">            path = AssetDatabase.GetAssetPath(asset);</span><br><span class="line">            mat = asset <span class="keyword">as</span> Material;</span><br><span class="line">            <span class="keyword">if</span> (mat == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mat.shader = Shader.Find(<span class="string">&quot;Mogo/UIETC&quot;</span>);</span><br><span class="line">            mainTexture = AssetDatabase.LoadAssetAtPath(path.Replace(asset.name + <span class="string">&quot;.mat&quot;</span>, <span class="string">&quot;etc/&quot;</span> + asset.name + <span class="string">&quot;.png&quot;</span>), <span class="keyword">typeof</span>(Texture2D)) <span class="keyword">as</span> Texture2D;</span><br><span class="line">            mat.mainTexture = mainTexture;</span><br><span class="line">            alphaTexture = AssetDatabase.LoadAssetAtPath(path.Replace(asset.name + <span class="string">&quot;.mat&quot;</span>, <span class="string">&quot;etc/&quot;</span> + asset.name + <span class="string">&quot;_alpha.png&quot;</span>), <span class="keyword">typeof</span>(Texture2D)) <span class="keyword">as</span> Texture2D;</span><br><span class="line">            mat.SetTexture(<span class="string">&quot;_AlphaTex&quot;</span>, alphaTexture);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>4,运行效果</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://godwintsai.github.io/2017/12/13/ETC1+Alpha%E7%BA%B9%E7%90%86%E5%8E%8B%E7%BC%A9%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC/" data-id="cl5nt970v0005mpuv3unhfuht" data-title="ETC1+Alpha纹理压缩自动化脚本" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ETC1-Alpha/" rel="tag">ETC1 Alpha</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Unity&amp;NGUI渲染层级" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/11/08/Unity&NGUI%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7/" class="article-date">
  <time class="dt-published" datetime="2017-11-08T06:00:02.000Z" itemprop="datePublished">2017-11-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Unity/">Unity</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/11/08/Unity&NGUI%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7/">Unity&amp;NGUI渲染层级</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <span id="more"></span>

<p>尊重原创，转载请在文首注明出处：<a target="_blank" rel="noopener" href="http://blog.csdn.net/cai612781/article/details/78477944">http://blog.csdn.net/cai612781/article/details/78477944</a>  </p>
<p>项目中经常遇到层级的显示问题，来总结下。</p>
<h1 id="一，Unity"><a href="#一，Unity" class="headerlink" title="一，Unity"></a>一，Unity</h1><p>按优先级从高到低排列：</p>
<h2 id="1，Camera-depth"><a href="#1，Camera-depth" class="headerlink" title="1，Camera.depth"></a>1，Camera.depth</h2><p>depth小的先渲染。</p>
<p><img src="https://img-blog.csdn.net/20171108235141309?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">  </p>
<h2 id="2，Renderer-sortingLayerID"><a href="#2，Renderer-sortingLayerID" class="headerlink" title="2，Renderer.sortingLayerID"></a>2，Renderer.sortingLayerID</h2><p>sortingLayerID为基类Renderer的属性，sortingLayerID小的先渲染。</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>3，Renderer.sortingOrder</p>
<p>sortingOrder同为基类Renderer的属性，sortingOrder小的先渲染。</p>
<p>sortingLayerID和sortingOrder虽然是基类Renderer的属性，但只适用于Unity2d的排序，因此我们在面板中可以看到只有显示图片的SpriteRenderer和显示粒子的</p>
<p>ParticleSystemRenderer有这两个属性。</p>
<p><img src="https://img-blog.csdn.net/20171108235453765?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"><img src="https://img-blog.csdn.net/20171108235556426?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">  </p>
<h2 id="4，Material-renderQueue"><a href="#4，Material-renderQueue" class="headerlink" title="4，Material.renderQueue"></a>4，Material.renderQueue</h2><p>该属性对应的是Shader的renderQueue，renderQueue的范围必须是[0,5000]，数值小的先渲染。Shader中使用SubShader的Queue标签来设定模型属于哪个渲染队列。</p>
<p>Unity内置了几个渲染队列的枚举：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> RenderQueue</span><br><span class="line">&#123;</span><br><span class="line">        Background = <span class="number">1000</span>,<span class="comment">//最先渲染，通常用来绘制背景</span></span><br><span class="line">        Geometry = <span class="number">2000</span>,<span class="comment">//不透明物体的渲染</span></span><br><span class="line">        AlphaTest = <span class="number">2450</span>, <span class="comment">// 需要透明度测试的物体，在不透明物体渲染后再渲染会更高效</span></span><br><span class="line">        GeometryLast = <span class="number">2500</span>, <span class="comment">// 分界线，[0,2500]为不透明物体，[2501,5000]为半透明物体</span></span><br><span class="line">        Transparent = <span class="number">3000</span>,<span class="comment">//半透明物体的渲染，任何使用了透明度混合（例如关闭了深度写入）的物体都用得用该队列</span></span><br><span class="line">        Overlay = <span class="number">4000</span>,<span class="comment">//用于叠加效果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述排序是在Shader关闭了深度写入（ZWrite Off）的情况下，当开启了深度写入时，物体的空间位置（transform.position.z）会影响层级，z值小的在前面。</p>
<p>另外，Unity菜单Edit-&gt;Project Settings-&gt;Tags中的Layers,只是一个逻辑的分层，用于Camera的Culling Mask来设置相机渲染哪个Layer的物体，辅助Camera.depth来管理层级。</p>
<h1 id="二，NGUI"><a href="#二，NGUI" class="headerlink" title="二，NGUI"></a>二，NGUI</h1><p>按优先级从高到低排列：  </p>
<h2 id="1，UIPanel-sortingOrder"><a href="#1，UIPanel-sortingOrder" class="headerlink" title="1，UIPanel.sortingOrder"></a>1，UIPanel.sortingOrder</h2><p>通过源码可以看到UIPanel.sortingOrder更改的就是上文中Renderer.sortingOrder。</p>
<h2 id="2，UIPanel-depth"><a href="#2，UIPanel-depth" class="headerlink" title="2，UIPanel.depth"></a>2，UIPanel.depth</h2><p>depth小的先渲染</p>
<h2 id="3，UIWidget-depth"><a href="#3，UIWidget-depth" class="headerlink" title="3，UIWidget.depth"></a>3，UIWidget.depth</h2><p>depth小的先渲染，NGUI根据UIWidget.depth的排序合并drawcall（因此尽量将相同材质的图集在depth上排在一起可以减少UI上的drawcall）。</p>
<p>UIPanel面板还有个Render Q属性，用来设置该面板的renderQueue的起始值，所有面板总的起始值默认为3000。该属性有三种选项，分别是</p>
<p>Automatic，StartAt，Explicit，后两者可自定义renderQueue的起始值。</p>
<p><img src="https://img-blog.csdn.net/20171108235959691?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">  </p>
<p>当Render Q默认为Automatic时，根据UIPanel.depth的排序对drawcall的材质的renderqueue进行排序。</p>
<p>当Render Q默认为StartAt或Explicit时，UIPanel.depth则不起作用，根据自定义的值对drawcall的材质的renderqueue进行排序。</p>
<p>NGUI所用的shader都是关闭了深度写入的，因此z值不影响层级。所以NGUI本质还是通过Unity的sortingOrder和renderQueue来管理层级。</p>
<h1 id="三，NGUI与模型或特效的夹层问题"><a href="#三，NGUI与模型或特效的夹层问题" class="headerlink" title="三，NGUI与模型或特效的夹层问题"></a>三，NGUI与模型或特效的夹层问题</h1><p>我们在处理模型或特效显示在两个UI之间的层级显示问题，有两种方式：</p>
<p>1，利用Camera.depth属性，将界面A，模型或特效，界面B分别放在三个Layer，用三个depth递增的相机来渲染。（该方式不推荐，因为一个界面上可能会打开新的界面，以及两个界面的相对层次不是固定的，这样会导致相机不断增加，层次管理混乱）</p>
<p>2，利用renderQueue属性，给两个UIPanel之间留下一定范围的renderQueue数值，将模型或特效的renderQueue设置在这个范围内。（推荐该方式）</p>
<p>代码如下：</p>
<p>第一步，新增renderQueue控制脚本：RenderQueueContro.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RenderQueueControl</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> UIPanel _panel;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> _rq;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Material&gt; _materialList = <span class="keyword">new</span> List&lt;Material&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> i, len;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		_panel = NGUITools.FindInParents&lt;UIPanel&gt;(gameObject);</span><br><span class="line">		UIPanel.AddModelRQ(<span class="keyword">this</span>);</span><br><span class="line">		InitMaterials();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitMaterials</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		_materialList.Clear();</span><br><span class="line">		Renderer[] ren = GetComponentsInChildren&lt;Renderer&gt;();</span><br><span class="line">		<span class="keyword">if</span>(ren != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(i = <span class="number">0</span>, len = ren.Length; i &lt; len; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				_materialList.AddRange(ren[i].materials);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateRQ</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(_panel != <span class="literal">null</span> &amp;&amp; _panel.drawCalls.Count &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			_rq = _panel.drawCalls[_panel.drawCalls.Count - <span class="number">1</span>].renderQueue + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">for</span>(i = <span class="number">0</span>, len = _materialList; i &lt; len; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(_materialList[i].renderQueue != _rq)</span><br><span class="line">				&#123;</span><br><span class="line">					_materialList[i].renderQueue = _rq;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnDestroy</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		_materialList.Clear();</span><br><span class="line">		UIPanel.RemoveRQ(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二步，给两个UIPanel之间留下一定范围的renderQueue数值，并在UIPanel更新时修改模型的renderQueue。我们修改UIPanel.LateUpdate（注释为修改处）。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(mUpdateFrame != Time.frameCount)</span><br><span class="line">	&#123;</span><br><span class="line">		mUpdateFrame = Time.frameCount;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, imax = list.Count; i &lt; imax; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			list[i].UpdateSelf();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">int</span> rq = <span class="number">3000</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, imax = list.Count; i &lt; imax; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			UIPanel p = list[i];</span><br><span class="line">			<span class="keyword">if</span>(p.renderQueue == RenderQueue.Automatic)</span><br><span class="line">			&#123;</span><br><span class="line">				p.startingRenderQueue = rq;</span><br><span class="line">				p.UpdateDrawCalls();</span><br><span class="line">				rq += p.drawCalls.Count * <span class="number">2</span>;<span class="comment">//加上*2</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(p.renderQueue == RenderQueue.StartAt)</span><br><span class="line">			&#123;</span><br><span class="line">				p.UpdateDrawCalls();</span><br><span class="line">				<span class="keyword">if</span>(p.drawCalls.Count != <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					rq = Mathf.Max(rq, p.startingRenderQueue + p.drawCalls.Count * <span class="number">2</span>);<span class="comment">//加上*2</span></span><br><span class="line"></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				p.UpdateDrawCalls();</span><br><span class="line">				<span class="keyword">if</span>(p.drawCalls.Count != <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					rq = Mathf.Max(rq, p.startingRenderQueue + <span class="number">1</span> * <span class="number">2</span>);<span class="comment">//加上*2</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		UpdateModelRQ();<span class="comment">//加上刷新rq</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;RenderQueueControl&gt; _modelRQList = <span class="keyword">new</span> List&lt;RenderQueueControl&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddModelRQ</span>(<span class="params">RenderQueueControl control</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(!_modelRQList.Contains(control))</span><br><span class="line">	&#123;</span><br><span class="line">		_modelRQList.Add(control);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveModelRQ</span>(<span class="params">RenderQueueControl control</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	_modelRQList.Remove(control);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateModelRQ</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, len = _modelRQList.Count; i &lt; len; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(_modelRQList[i] == <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		_modelRQList[i].UpdateRQ();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三步，加载模型或特效后的调用</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddModelParent</span>(<span class="params">GameObject modelGo, Transform parentTran</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(modelGo == <span class="literal">null</span> || parentTran == <span class="literal">null</span> || parentTran.gameObject == <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	modelGo.transform.parent = parentTran;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">int</span> layerUi = parentTran.gameObject.layer;</span><br><span class="line">	SetLayerRecursively(parentTran.gameObject, layerUi);</span><br><span class="line">	</span><br><span class="line">	RenderQueueControl rqControl = modelGo.AddMissingComponent&lt;RenderQueueControl&gt;();</span><br><span class="line">	rqControl.Init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetLayerRecursively</span>(<span class="params">GameObject parent, <span class="built_in">int</span> layer</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(parent == <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	parent.layer = layer;</span><br><span class="line">	<span class="keyword">foreach</span>(Transform child <span class="keyword">in</span> parent.transform)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(child == <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		SetLayerRecursively(child.gameObject, layer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果图</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://godwintsai.github.io/2017/11/08/Unity&NGUI%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7/" data-id="cl5nt9710000fmpuvdvqjhgmo" data-title="Unity&amp;NGUI渲染层级" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unity%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7-ngui%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7/" rel="tag">Unity渲染层级 ngui渲染层级</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-脚本解析photoshop文本属性" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/09/23/%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90photoshop%E6%96%87%E6%9C%AC%E5%B1%9E%E6%80%A7/" class="article-date">
  <time class="dt-published" datetime="2017-09-23T10:35:11.000Z" itemprop="datePublished">2017-09-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PhotoShop/">PhotoShop</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/09/23/%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90photoshop%E6%96%87%E6%9C%AC%E5%B1%9E%E6%80%A7/">脚本解析photoshop文本属性</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <span id="more"></span>

<p>尊重原创，转载请在文首注明出处：<a target="_blank" rel="noopener" href="http://blog.csdn.net/cai612781/article/details/78072531">http://blog.csdn.net/cai612781/article/details/78072531</a></p>
<p>在做unity项目中，用到了psd2ngui插件来把psd直接导出成prefab，psd2ngui的原理就是解析psd中图层的命名来生成组件。用的还是最早的版本，插件中导出的文本只有一个文本内容，其余属性例如颜色、字号、描边、投影都得另外设置，很麻烦，新版不知有没这功能，一直没有继续研究。于是当时就有了这么个想法，写个ps脚本，解析文本的属性并命名，再扩展插件来实现导出ui后不用额外修改文本属性。这也是很早很早之前做的，现在来总结下。</p>
<h2 id="语言"><a href="#语言" class="headerlink" title="语言"></a>语言</h2><p>ps支持几种脚本语言，Mac平台有AppleScript,Windows平台有VBScript，以及两个平台都支持的JavaScript。我用的就是Js语言，后缀是jsx。</p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>可以使用任何文本编辑来写代码，这里推荐Adobe的IDE，叫Adobe ExtendScript Tookit，支持断点调试，还可以通过Data Browser窗口查看对象的属性和方法。</p>
<p><img src="https://img-blog.csdn.net/20171105130835946?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">  </p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><p>ps script一种方式是通过文本对象模型DOM（Document Object Model）来访问和修改psd中的对象的属性，直观而方便，但不能实现所有的ps操作。 </p>
<p>ps dom类结构图：</p>
<p><img src="https://img-blog.csdn.net/20171105144858740?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">  </p>
<p>另一种方式是通过动作代理(ActionManager)的方式，可以实现比DOM更多的操作，但貌似不支持AppleScript。</p>
<p>动作代理主要类有ActionDescriptor，ActionReference，ActionList。</p>
<p>ActionDescriptor相当于一个存储属性和值的字典,</p>
<p>ActionList是一个存储相同属性的值的数组，</p>
<p>ActionReference存储一个action的引用，</p>
<p>举个栗子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">emboss</span>(<span class="params">inAngle, inHeight, inAmount</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> keyAngleID = <span class="title function_">charIDToTypeID</span>(<span class="string">&quot;Angl&quot;</span>);</span><br><span class="line">	<span class="keyword">var</span> keyHeightID = <span class="title function_">charIDToTypeID</span>(<span class="string">&quot;Hght&quot;</span>);</span><br><span class="line">	<span class="keyword">var</span> keyAmountID = <span class="title function_">charIDToTypeID</span>(<span class="string">&quot;Amnt&quot;</span>);</span><br><span class="line">	<span class="keyword">var</span> eventEmbossID = <span class="title function_">charIDToTypeID</span>(<span class="string">&quot;Embs&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> filterDescriptor = <span class="keyword">new</span> <span class="title class_">ActionDescriptor</span>();</span><br><span class="line">	filterDescriptor.<span class="title function_">putInteger</span>(keyAngleID, inAngle);</span><br><span class="line">	filterDescriptor.<span class="title function_">putInteger</span>(keyHeightID, inHeight);</span><br><span class="line">	filterDescriptor.<span class="title function_">putInteger</span>(keyAmountID, inAmount);</span><br><span class="line">	</span><br><span class="line">	<span class="title function_">executeAction</span>(eventEmbossID, filterDescriptor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">emboss</span>(<span class="number">120</span>, <span class="number">10</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<p>运行该脚本，会给选中图层添加一个浮雕滤镜</p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>ActionManager看起来比DOM复杂繁琐，好在Adobe有个监听Action的插件，下载地址：</p>
<p>Windows： <a target="_blank" rel="noopener" href="http://download.adobe.com/pub/adobe/photoshop/win/13.x/Win_Scripting_Plug-In.zip">ScriptingListenerPlugInForWindow</a> </p>
<p>Mac：<a target="_blank" rel="noopener" href="http://download.adobe.com/pub/adobe/photoshop/mac/13.x/Scripting_Plug_In_Release.dmg">ScriptingListenerPlugInForMac </a></p>
<p>下载解压后将ScriptListener.8li拷贝到Adobe Photoshop&#x2F;Plug-ins&#x2F;目录下即可。</p>
<p>重开ps，操作将会被记录在桌面的ScriptingListenerJS.log和ScriptingListenerVB.log中</p>
<p>切记不用时把该插件移除，需要时再复制到Plug-ins目录下，以免撑爆磁盘以及影响ps操作性能。或者使用下载的压缩包里带有两个开关插件的脚本。</p>
<p><img src="https://img-blog.csdn.net/20171105133542960?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"></p>
<p>上图记录了我打开一张图片，选中它，改变颜色三个步骤的脚步。</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h4 id="遍历所有文本图层"><a href="#遍历所有文本图层" class="headerlink" title="##遍历所有文本图层"></a>##遍历所有文本图层</h4><p>ps script中跟图层相关的对象有LayerSet(组)，ArtLayer(图层)，Layer(包括组和图层)。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getTextLayers</span>(<span class="params">layers</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = layers.<span class="property">length</span>; i &lt; len; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(layers[i].<span class="property">typename</span> == <span class="string">&quot;LayerSet&quot;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="title function_">getTextLayers</span>(layers[i].<span class="property">layers</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(layers[i].<span class="property">kind</span> == <span class="title class_">LayerKind</span>.<span class="property">TEXT</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//得到文本图层</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">getTextLayers</span>(app.<span class="property">activeDocument</span>.<span class="property">layers</span>);</span><br></pre></td></tr></table></figure>

<h4 id="文本字号和颜色"><a href="#文本字号和颜色" class="headerlink" title="##文本字号和颜色"></a>##文本字号和颜色</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> text = layer.<span class="property">textItem</span>;<span class="comment">//layer即上文得到的layers[i]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> color = text.<span class="property">color</span>.<span class="property">rgb</span>[<span class="string">&quot;hexValue&quot;</span>];</span><br><span class="line"><span class="keyword">var</span> size = text.<span class="property">size</span>.<span class="property">value</span>;</span><br></pre></td></tr></table></figure>

<p>下面代码是怎么从layer获得ActionDescriptor， 需要先将layer设置为目标图层：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="property">activeDocument</span>.<span class="property">activeLayer</span> = layer;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">char2Type</span>(<span class="params">charId</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> app.<span class="title function_">charIDToTypeID</span>(charId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getActiveLayerDescriptor</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> ref = <span class="keyword">new</span> <span class="title class_">ActionReference</span>();</span><br><span class="line">	ref.<span class="title function_">putEnumerated</span>(<span class="title function_">char2Type</span>(<span class="string">&quot;Lyr &quot;</span>), <span class="title function_">char2Type</span>(<span class="string">&quot;Ordn&quot;</span>), <span class="title function_">char2Type</span>(<span class="string">&quot;Trgt&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">executeActionGet</span>(ref);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> layerDesc = <span class="title function_">getActiveLayerDescriptor</span>();</span><br></pre></td></tr></table></figure>

<h4 id="描边-x2F-投影颜色"><a href="#描边-x2F-投影颜色" class="headerlink" title="##描边&#x2F;投影颜色"></a>##描边&#x2F;投影颜色</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getOutline</span>(<span class="params">layerDesc</span>)<span class="comment">//layerDesc参数即上文通过layer获得的ActionDescriptor类型对象</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> isEffectVisible = layerDesc.<span class="title function_">getVal</span>(<span class="string">&quot;layerFXVisible&quot;</span>);<span class="comment">//判断图层是否有可见效果</span></span><br><span class="line">	<span class="keyword">if</span>(!isEffectVisible)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> lfxDesc = layerDesc.<span class="title function_">getVal</span>(<span class="string">&quot;layerEffects&quot;</span>);<span class="comment">//获得图层效果属性</span></span><br><span class="line">	<span class="keyword">var</span> dsDesc = lfxDesc ? lfxDesc.<span class="title function_">getVal</span>(<span class="string">&quot;frameFX&quot;</span>) : <span class="literal">null</span>;<span class="comment">//获得图层描边属性</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//var dsDesc = lfxDesc ? lfxDesc.getVal(&quot;dropShadow&quot;) : null;//获得图层投影属性</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(dsDesc == <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> enable = dsDesc.<span class="title function_">getVal</span>(<span class="string">&quot;enabled&quot;</span>);<span class="comment">//判断描边/投影是否启用</span></span><br><span class="line">	<span class="keyword">if</span>(!enable)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> rgbTxt = <span class="title function_">descToColorList</span>(dsDesc, <span class="string">&quot;color&quot;</span>);<span class="comment">//获得图层描边/投影颜色</span></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">changeToHex</span>(rgbTxt);<span class="comment">//转换成16进制</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="渐变颜色"><a href="#渐变颜色" class="headerlink" title="##渐变颜色"></a>##渐变颜色</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getGradientFill</span>(<span class="params">layerDesc</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> isEffectVisible = layerDesc.<span class="title function_">getVal</span>(<span class="string">&quot;layerFXVisible&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(!isEffectVisible)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> lfxDesc = layerDesc.<span class="title function_">getVal</span>(<span class="string">&quot;layerEffects&quot;</span>);</span><br><span class="line">	<span class="keyword">var</span> dsDesc = lfxDesc ? lfxDesc.<span class="title function_">getVal</span>(<span class="string">&quot;gradientFill&quot;</span>) : <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">if</span>(dsDesc == <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> enable = dsDesc.<span class="title function_">getVal</span>(<span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(!enable)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> graDesc = dsDesc.<span class="title function_">getVal</span>(<span class="string">&quot;gradient&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> colorList = graDesc.<span class="title function_">getVal</span>(<span class="string">&quot;colors&quot;</span>, <span class="literal">false</span>);<span class="comment">//ps中可以有多个渐变颜色，unity中一般两个</span></span><br><span class="line">	<span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span>(s <span class="keyword">in</span> colorList)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> rgbTxt = <span class="title function_">descToColorList</span>(colorList[s], <span class="string">&quot;color&quot;</span>);</span><br><span class="line">		result += <span class="title function_">changeToHex</span>(rgbTxt) + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	result = result.<span class="title function_">substr</span>(<span class="number">0</span>, result.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用方法"><a href="#调用方法" class="headerlink" title="##调用方法"></a>##调用方法</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///desc.getVal( keyList );方法的实现，获得desc的属性keyList对应的值</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ActionDescriptor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getVal</span> = <span class="keyword">function</span>(<span class="params">keyList, firstListItemOnly</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_">typeof</span>(keyList) == <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		keyList = keyList.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_">typeof</span>(firstListItemOnly) == <span class="string">&quot;undefined&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		firstListItemOnly = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (keyList.<span class="property">length</span> == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	keyStr = keyList.<span class="title function_">shift</span>();</span><br><span class="line">	keyID = <span class="title function_">makeID</span>(keyStr);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">hasKey</span>(keyID))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="title function_">getType</span>(keyID))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">OBJECTTYPE</span>:<span class="comment">//属性类型为Object</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getObjectValue</span>(keyID).<span class="title function_">getVal</span>(keyList, firstListItemOnly);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">LISTTYPE</span>:<span class="comment">//属性类型为列表</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">var</span> list = <span class="variable language_">this</span>.<span class="title function_">getList</span>(keyID); </span><br><span class="line">				<span class="keyword">return</span> list.<span class="title function_">getVal</span>(keyList, firstListItemOnly);</span><br><span class="line">			&#125;	</span><br><span class="line">			<span class="attr">default</span>: </span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getFlatType</span>(keyID);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///将charID或stringID转换成TypeID</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">charID、string相当于底层定义的属性枚举</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">makeID</span>(<span class="params">keyStr</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (keyStr[<span class="number">0</span>] == <span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> app.<span class="title function_">charIDToTypeID</span>(keyStr);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> app.<span class="title function_">stringIDToTypeID</span>(keyStr);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///根据不同类型获得最终的值</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getFlatType</span>(<span class="params">desc, ID</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">switch</span> (desc.<span class="title function_">getType</span>(<span class="variable constant_">ID</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">BOOLEANTYPE</span>:		<span class="keyword">return</span> desc.<span class="title function_">getBoolean</span>(<span class="variable constant_">ID</span>);</span><br><span class="line">		<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">STRINGTYPE</span>:		<span class="keyword">return</span> desc.<span class="title function_">getString</span>(<span class="variable constant_">ID</span>);</span><br><span class="line">		<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">INTEGERTYPE</span>:		<span class="keyword">return</span> desc.<span class="title function_">getInteger</span>(<span class="variable constant_">ID</span>);</span><br><span class="line">		<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">DOUBLETYPE</span>:		<span class="keyword">return</span> desc.<span class="title function_">getDouble</span>(<span class="variable constant_">ID</span>);</span><br><span class="line">		<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">UNITDOUBLE</span>:		<span class="keyword">return</span> <span class="title function_">getPSUnitValue</span>(desc, <span class="variable constant_">ID</span>);</span><br><span class="line">		<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">ENUMERATEDTYPE</span>: 	<span class="keyword">return</span> <span class="title function_">typeIDToStringID</span>(desc.<span class="title function_">getEnumerationValue</span>(<span class="variable constant_">ID</span>));</span><br><span class="line">		<span class="keyword">case</span> <span class="title class_">DescValueType</span>.<span class="property">REFERENCETYPE</span>: 	<span class="keyword">return</span> <span class="title function_">getReference</span>(desc.<span class="title function_">getReference</span>(<span class="variable constant_">ID</span>));</span><br><span class="line">		<span class="attr">default</span>: 				<span class="keyword">return</span> desc.<span class="title function_">getType</span>(<span class="variable constant_">ID</span>).<span class="title function_">toString</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///获得颜色rgb值</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">descToColorList</span>(<span class="params">colorDesc, colorPath</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> i, rgb = [<span class="string">&quot;&#x27;Rd  &#x27;&quot;</span>, <span class="string">&quot;&#x27;Grn &#x27;&quot;</span>,<span class="string">&quot;&#x27;Bl  &#x27;&quot;</span>];</span><br><span class="line">	<span class="keyword">var</span> rgbTxt = [];</span><br><span class="line">	</span><br><span class="line">	colorDesc = colorDesc.<span class="title function_">getVal</span>(colorPath);</span><br><span class="line">	<span class="keyword">if</span> (!colorDesc)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i <span class="keyword">in</span> rgb)</span><br><span class="line">	&#123;</span><br><span class="line">		rgbTxt.<span class="title function_">push</span>( <span class="title function_">roundColor</span>(colorDesc.<span class="title function_">getVal</span>(rgb[i])));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rgbTxt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///转换成16进制颜色值</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">changeToHex</span>(<span class="params">rgbTxt</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> value = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = rgbTxt.<span class="property">length</span>; i &lt; len; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> string = rgbTxt[i].<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">		<span class="keyword">if</span>(string.<span class="property">length</span> &lt; <span class="number">2</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			string = <span class="string">&quot;0&quot;</span> + string;</span><br><span class="line">		&#125;</span><br><span class="line">		value += string;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>将代码保存为.jsx后缀文件，放在ps安装目录\Presets\Scripts\下</p>
<p>运行路径：ps中文件-脚本-.jsx</p>
<p>运行结果图</p>
<p>运行前：</p>
<p><img src="https://img-blog.csdn.net/20171105141904470?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">  </p>
<p>运行后：</p>
<p><img src="https://img-blog.csdn.net/20171105141923655?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2FpNjEyNzgx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center">  </p>
<p>以上就是ps脚本解析psd中文本图层的描边、投影、渐变等属性的主要代码，文本还有许多其它属性，不过unity项目中基本不用。</p>
<p>完整的脚本在github:<a target="_blank" rel="noopener" href="https://github.com/503913873/PhotoshopTextParse">https://github.com/503913873/PhotoshopTextParse</a></p>
<p>该脚本写得比较早，脚本中一些方法写得比较繁琐，例如遍历图层是用ActionManager方式，没有文中采用DOM方式来得简洁易懂，</p>
<p>github里第二个脚本就是文中的方式。</p>
<p>貌似ps不同版本的代码也有些差异，该脚本在cs5、cs6中都运行过，基本都可以用，小概率会出现解析的文本字号带小数。</p>
<p>更详细的语法可以在Adobe官网上查看：<a target="_blank" rel="noopener" href="http://www.adobe.com/devnet/photoshop/scripting.html">http://www.adobe.com/devnet/photoshop/scripting.html</a></p>
<p>文笔不好，又是第一次写，写了好多天，ps script研究得也不深，基本是需要什么功能才去搜索，欢迎大家一起讨论学习。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://godwintsai.github.io/2017/09/23/%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90photoshop%E6%96%87%E6%9C%AC%E5%B1%9E%E6%80%A7/" data-id="cl5nt97190013mpuv59zsfq1q" data-title="脚本解析photoshop文本属性" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/photoshop-script-ps-script-actionmanager/" rel="tag">photoshop script ps script actionmanager</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C#</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ngui/">Ngui</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PhotoShop/">PhotoShop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Timeline/">Timeline</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity/">Unity</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity-Optimize/">Unity Optimize</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B-C-%E8%B0%83%E7%94%A8%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6/" rel="tag">C#启动进程 C#调用可执行文件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6-%E5%88%A0%E9%99%A4%E5%8F%AA%E8%AF%BB%E6%96%87%E4%BB%B6%E5%BC%82%E5%B8%B8/" rel="tag">C#复制文件 删除只读文件异常</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-%E8%B0%83%E7%94%A8SVN/" rel="tag">C#调用SVN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ETC1-Alpha/" rel="tag">ETC1 Alpha</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Timeline/" rel="tag">Timeline</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Timeline-%E5%9D%91-%E8%B5%84%E6%BA%90%E5%BC%95%E7%94%A8-%E8%B5%84%E6%BA%90%E4%BE%9D%E8%B5%96/" rel="tag">Timeline 坑 资源引用 资源依赖</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/" rel="tag">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7-ngui%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7/" rel="tag">Unity渲染层级 ngui渲染层级</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/photoshop-script-ps-script-actionmanager/" rel="tag">photoshop script ps script actionmanager</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unity-coroutine-unity%E5%8D%8F%E7%A8%8B-use-coroutine-in-uni-%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8D%8F%E7%A8%8B/" rel="tag">unity coroutine unity协程 use coroutine in uni 编辑器中使用协程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C-%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B-C-%E8%B0%83%E7%94%A8%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6/" style="font-size: 10px;">C#启动进程 C#调用可执行文件</a> <a href="/tags/C-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6-%E5%88%A0%E9%99%A4%E5%8F%AA%E8%AF%BB%E6%96%87%E4%BB%B6%E5%BC%82%E5%B8%B8/" style="font-size: 10px;">C#复制文件 删除只读文件异常</a> <a href="/tags/C-%E8%B0%83%E7%94%A8SVN/" style="font-size: 10px;">C#调用SVN</a> <a href="/tags/ETC1-Alpha/" style="font-size: 10px;">ETC1 Alpha</a> <a href="/tags/Timeline/" style="font-size: 10px;">Timeline</a> <a href="/tags/Timeline-%E5%9D%91-%E8%B5%84%E6%BA%90%E5%BC%95%E7%94%A8-%E8%B5%84%E6%BA%90%E4%BE%9D%E8%B5%96/" style="font-size: 10px;">Timeline 坑 资源引用 资源依赖</a> <a href="/tags/Unity/" style="font-size: 10px;">Unity</a> <a href="/tags/Unity%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7-ngui%E6%B8%B2%E6%9F%93%E5%B1%82%E7%BA%A7/" style="font-size: 10px;">Unity渲染层级 ngui渲染层级</a> <a href="/tags/photoshop-script-ps-script-actionmanager/" style="font-size: 10px;">photoshop script ps script actionmanager</a> <a href="/tags/unity-coroutine-unity%E5%8D%8F%E7%A8%8B-use-coroutine-in-uni-%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8D%8F%E7%A8%8B/" style="font-size: 10px;">unity coroutine unity协程 use coroutine in uni 编辑器中使用协程</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/07/16/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2020/04/02/Skill&Buff%20Editor/">Skill&amp;Buff Editor</a>
          </li>
        
          <li>
            <a href="/2020/04/01/Unity%E4%B8%96%E7%95%8C%E5%9D%90%E6%A0%87%E5%B1%80%E9%83%A8%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2/">Unity世界坐标局部坐标转换</a>
          </li>
        
          <li>
            <a href="/2020/03/12/Unity%E5%8A%A8%E7%94%BB%E4%BC%98%E5%8C%96!Optimize%20Game%20Objects/">Unity动画优化:Optimize Game Objects</a>
          </li>
        
          <li>
            <a href="/2020/02/24/bilibili%E5%8F%91%E9%80%81%E5%BC%B9%E5%B9%95/">bilibili发送弹幕</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 GodwinTsai<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>